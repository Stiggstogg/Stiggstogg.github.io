<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CMB</title>
    <script type="module">
	var Lt=Object.defineProperty;var St=(s,t,e)=>t in s?Lt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var n=(s,t,e)=>(St(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))i(h);new MutationObserver(h=>{for(const o of h)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(h){const o={};return h.integrity&&(o.integrity=h.integrity),h.referrerPolicy&&(o.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?o.credentials="include":h.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(h){if(h.ep)return;h.ep=!0;const o=e(h);fetch(h.href,o)}})();/**
 * @preserve
 * Kontra.js v9.0.0
 */let K=()=>{},vt="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);";function ut(s,t){let e=t.parentNode;if(s.setAttribute("data-kontra",""),e){let i=e.querySelector("[data-kontra]:last-of-type")||t;e.insertBefore(s,i.nextSibling)}else document.body.appendChild(s)}function mt(s,t){let e=s.indexOf(t);if(e!=-1)return s.splice(e,1),!0}let D={};function T(s,t){D[s]=D[s]||[],D[s].push(t)}function Tt(s,t){D[s]=(D[s]||[]).filter(e=>e!=t)}function M(s,...t){(D[s]||[]).map(e=>e(...t))}let A,J,dt={get(s,t){return t=="_proxy"?!0:K}};function _t(){return A}function C(){return J}function Wt(s,{contextless:t=!1}={}){if(A=document.getElementById(s)||s||document.querySelector("canvas"),t&&(A=A||new Proxy({},dt)),!A)throw Error("You must provide a canvas element for the game");return J=A.getContext("2d")||new Proxy({},dt),J.imageSmoothingEnabled=!1,M("init"),{canvas:A,context:J}}function Mt(s,t){let e=Math.sin(t),i=Math.cos(t);return{x:s.x*i-s.y*e,y:s.x*e+s.y*i}}function nt(s,t,e){return Math.min(Math.max(s,e),t)}function Ct(s,t){return[s,t]=[s,t].map(e=>kt(e)),s.x<t.x+t.width&&s.x+s.width>t.x&&s.y<t.y+t.height&&s.y+s.height>t.y}function kt(s){let{x:t=0,y:e=0,width:i,height:h}=s.world||s;return s.mapwidth&&(i=s.mapwidth,h=s.mapheight),s.anchor&&(t-=i*s.anchor.x,e-=h*s.anchor.y),i<0&&(t+=i,i*=-1),h<0&&(e+=h,h*=-1),{x:t,y:e,width:i,height:h}}class F{constructor(t=0,e=0,i={}){t.x!=null?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new F(this.x+t.x,this.y+t.y,this)}subtract(t){return new F(this.x-t.x,this.y-t.y,this)}scale(t){return new F(this.x*t,this.y*t)}normalize(t=this.length()||1){return new F(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}direction(){return Math.atan2(this.y,this.x)}clamp(t,e,i,h){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=h}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?nt(this._a,this._d,t):t}set y(t){this._y=this._c?nt(this._b,this._e,t):t}}function it(){return new F(...arguments)}class Et{constructor(t){return this.init(t)}init(t={}){this.position=it(),this.velocity=it(),this.acceleration=it(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration;t&&(e=e.scale(t)),this.velocity=this.velocity.add(e);let i=this.velocity;t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}class $ extends Et{init({width:t=0,height:e=0,context:i=C(),render:h=this.draw,update:o=this.advance,children:r=[],anchor:u={x:0,y:0},opacity:c=1,rotation:d=0,scaleX:l=1,scaleY:_=1,...x}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:u,opacity:c,rotation:d,scaleX:l,scaleY:_,...x}),this._di=!0,this._uw(),this.addChild(r),this._rf=h,this._uf=o,T("init",()=>{this.context??(this.context=C())})}update(t){this._uf(t),this.children.map(e=>e.update&&e.update(t))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),(this.scaleX!=1||this.scaleY!=1)&&t.scale(this.scaleX,this.scaleY);let e=-this.width*this.anchor.x,i=-this.height*this.anchor.y;(e||i)&&t.translate(e,i),this.context.globalAlpha=this.opacity,this._rf(),(e||i)&&t.translate(-e,-i),this.children.map(o=>o.render&&o.render()),t.restore()}draw(){}_pc(){this._uw(),this.children.map(t=>t._pc())}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wr:h=0,_wsx:o=1,_wsy:r=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this._wo=i*this.opacity,this._wsx=o*this.scaleX,this._wsy=r*this.scaleY,this._wx=this._wx*o,this._wy=this._wy*r,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this._wr=h+this.rotation;let{x:u,y:c}=Mt({x:this._wx,y:this._wy},h);this._wx=u,this._wy=c,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,opacity:this._wo,rotation:this._wr,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...t){t.flat().map(e=>{this.children.push(e),e.parent=this,e._pc=e._pc||K,e._pc()})}removeChild(...t){t.flat().map(e=>{mt(this.children,e)&&(e.parent=null,e._pc())})}get opacity(){return this._opa}set opacity(t){this._opa=nt(0,1,t),this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}class X extends ${init({image:t,width:e=t?t.width:void 0,height:i=t?t.height:void 0,...h}={}){super.init({image:t,width:e,height:i,...h})}get animations(){return this._a}set animations(t){let e,i;this._a={};for(e in t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){var e;(e=this.currentAnimation)==null||e.stop(),this.currentAnimation=this.animations[t],this.currentAnimation.start()}advance(t){var e;super.advance(t),(e=this.currentAnimation)==null||e.update(t)}draw(){this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.width,this.height))}}function z(){return new X(...arguments)}let Ht=/(\d+)(\w+)/;function Rt(s){if(!s)return{computed:0};let t=s.match(Ht),e=+t[1],i=t[2];return{size:e,unit:i,computed:e}}class At extends ${init({text:t="",textAlign:e="",lineHeight:i=1,font:h=(r=>(r=C())==null?void 0:r.font)(),...o}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:h,...o}),this.context&&this._p(),T("init",()=>{this.font??(this.font=C().font),this._p()})}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=Rt(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context,e=[this.text];if(t.font=this.font,e=this.text.split(`
`),this._fw&&e.map(i=>{let h=i.split(" "),o=h.shift(),r=o;h.map(u=>{r+=" "+u,t.measureText(r).width>this._fw&&(this._s.push(o),r=u),o=r}),this._s.push(r)}),!this._s.length&&this.text.includes(`
`)){let i=0;e.map(h=>{this._s.push(h),i=Math.max(i,t.measureText(h).width)}),this._w=this._fw||i}this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=0,e=this.textAlign,i=this.context;e=this.textAlign||(i.canvas.dir=="rtl"?"right":"left"),t=e=="right"?this.width:e=="center"?this.width/2|0:0,this._s.map((h,o)=>{i.textBaseline="top",i.textAlign=e,i.fillStyle=this.color,i.font=this.font,this.strokeColor&&(i.strokeStyle=this.strokeColor,i.lineWidth=this.lineWidth??1,i.strokeText(h,t,this._fs*this.lineHeight*o)),i.fillText(h,t,this._fs*this.lineHeight*o)})}}function g(){return new At(...arguments)}let I=new WeakMap,pt={},at={},bt={0:"left",1:"middle",2:"right"};function Vt(s,t){let{x:e,y:i,width:h,height:o}=kt(s);do e-=s.sx||0,i-=s.sy||0;while(s=s.parent);let r=t.x-Math.max(e,Math.min(t.x,e+h)),u=t.y-Math.max(i,Math.min(t.y,i+o));return r*r+u*u<t.radius*t.radius}function Pt(s){let t=s._lf.length?s._lf:s._cf;for(let e=t.length-1;e>=0;e--){let i=t[e];if(i.collidesWithPointer?i.collidesWithPointer(s):Vt(i,s))return i}}function B(s,t){return parseFloat(s.getPropertyValue(t))||0}function Gt(s){let{canvas:t,_s:e}=s,i=t.getBoundingClientRect(),h=e.transform!="none"?e.transform.replace("matrix(","").split(","):[1,1,1,1],o=parseFloat(h[0]),r=parseFloat(h[3]),u=(B(e,"border-left-width")+B(e,"border-right-width"))*o,c=(B(e,"border-top-width")+B(e,"border-bottom-width"))*r,d=(B(e,"padding-left")+B(e,"padding-right"))*o,l=(B(e,"padding-top")+B(e,"padding-bottom"))*r;return{scaleX:(i.width-u-d)/t.width,scaleY:(i.height-c-l)/t.height,offsetX:i.left+(B(e,"border-left-width")+B(e,"padding-left"))*o,offsetY:i.top+(B(e,"border-top-width")+B(e,"padding-top"))*r}}function ft(s){let t=s.button!=null?bt[s.button]:"left";at[t]=!0,lt(s,"onDown")}function st(s){let t=s.button!=null?bt[s.button]:"left";at[t]=!1,lt(s,"onUp")}function gt(s){lt(s,"onOver")}function Yt(s){let t=I.get(s.target);t._oo=null,at={}}function xt(s,t,e){let i=Pt(s);i&&i[t]&&i[t](e),pt[t]&&pt[t](e,i),t=="onOver"&&(i!=s._oo&&s._oo&&s._oo.onOut&&s._oo.onOut(e),s._oo=i)}function lt(s,t){s.preventDefault();let e=s.target,i=I.get(e),{scaleX:h,scaleY:o,offsetX:r,offsetY:u}=Gt(i);s.type.includes("touch")?(Array.from(s.touches).map(({clientX:d,clientY:l,identifier:_})=>{let x=i.touches[_];x||(x=i.touches[_]={start:{x:(d-r)/h,y:(l-u)/o}},i.touches.length++),x.changed=!1}),Array.from(s.changedTouches).map(({clientX:d,clientY:l,identifier:_})=>{let x=i.touches[_];x.changed=!0,x.x=i.x=(d-r)/h,x.y=i.y=(l-u)/o,xt(i,t,s),M("touchChanged",s,i.touches),t=="onUp"&&(delete i.touches[_],i.touches.length--,i.touches.length||M("touchEnd"))})):(i.x=(s.clientX-r)/h,i.y=(s.clientY-u)/o,xt(i,t,s))}function Ft({radius:s=5,canvas:t=_t()}={}){let e=I.get(t);if(!e){let i=window.getComputedStyle(t);e={x:0,y:0,radius:s,touches:{length:0},canvas:t,_cf:[],_lf:[],_o:[],_oo:null,_s:i},I.set(t,e)}return t.addEventListener("mousedown",ft),t.addEventListener("touchstart",ft),t.addEventListener("mouseup",st),t.addEventListener("touchend",st),t.addEventListener("touchcancel",st),t.addEventListener("blur",Yt),t.addEventListener("mousemove",gt),t.addEventListener("touchmove",gt),e._t||(e._t=!0,T("tick",()=>{e._lf.length=0,e._cf.map(i=>{e._lf.push(i)}),e._cf.length=0})),e}function P(...s){s.flat().map(t=>{let e=t.context?t.context.canvas:_t(),i=I.get(e);if(!i)throw new ReferenceError("Pointer events not initialized for the objects canvas");t._r||(t._r=t.render,t.render=function(){i._cf.push(this),this._r()},i._o.push(t))})}function Ot(s){let t=s.canvas;s.clearRect(0,0,t.width,t.height)}function Dt({fps:s=60,clearCanvas:t=!0,update:e=K,render:i,context:h=C(),blur:o=!1}={}){if(!i)throw Error("You must provide a render() function");let r=0,u=1e3/s,c=1/s,d=t?Ot:K,l,_,x,w,m,L=!0;o||(window.addEventListener("focus",()=>{L=!0}),window.addEventListener("blur",()=>{L=!1})),T("init",()=>{m.context??(m.context=C())});function b(){if(_=requestAnimationFrame(b),!!L&&(x=performance.now(),w=x-l,l=x,!(w>1e3))){for(M("tick"),r+=w;r>=u;)m.update(c),r-=u;d(m.context),m.render()}}return m={update:e,render:i,isStopped:!0,context:h,start(){l=performance.now(),this.isStopped=!1,requestAnimationFrame(b)},stop(){this.isStopped=!0,cancelAnimationFrame(_)},_frame:b,set _last(f){l=f}},m}let Xt={set(s,t,e){return t.startsWith("_")||(s._d=!0),Reflect.set(s,t,e)}},wt={start(s){return s?1:0},center(){return .5},end(s){return s?0:1}};class jt extends ${init({flow:t="column",align:e="start",justify:i="start",colGap:h=0,rowGap:o=0,numCols:r=1,dir:u="",breakpoints:c=[],...d}={}){return super.init({flow:t,align:e,justify:i,colGap:h,rowGap:o,numCols:r,dir:u,breakpoints:c,...d}),this._p(),new Proxy(this,Xt)}addChild(t){this._d=!0,super.addChild(t)}removeChild(t){this._d=!0,super.removeChild(t)}render(){this._d&&this._p(),super.render()}destroy(){this.children.map(t=>t.destroy&&t.destroy())}_p(){this._d=!1,this.breakpoints.map(f=>{f.metric.call(this)&&this._b!==f&&(this._b=f,f.callback.call(this))});let t=this._g=[],e=this._cw=[],i=this._rh=[],h=this.children,o=this._nc=this.flow=="column"?1:this.flow=="row"?h.length:this.numCols,r=0,u=0;for(let f=0,y;y=h[f];f++){t[r]=t[r]||[],y._p&&y._p();let{width:U,height:k}=y.world||y;i[r]=Math.max(i[r]||0,k);let S=y.colSpan||1,Y=S;do e[u]=Math.max(e[u]||0,U/Y),t[r][u]=y;while(u++<=o&&--S);u>=o&&(u=0,r++)}for(;u>0&&u<o;)t[r][u++]=!1;let c=t.length,d=[].concat(this.colGap),l=[].concat(this.rowGap);this._w=e.reduce((f,y)=>f+=y,0);for(let f=0;f<o-1;f++)this._w+=d[f%d.length];this._h=i.reduce((f,y)=>f+=y,0);for(let f=0;f<c-1;f++)this._h+=l[f%l.length];this._uw();let x=this.context.canvas.dir=="rtl"&&!this.dir||this.dir=="rtl";this._rtl=x,x&&(this._g=t.map(f=>f.reverse()),this._cw=e.reverse(),d=d.reverse());let w=-this.anchor.y*this.height,m=[],L=[].concat(this.justify),b=[].concat(this.align);this._g.map((f,y)=>{let U=-this.anchor.x*this.width;f.map((k,S)=>{if(k&&!m.includes(k)){m.push(k);let Y=wt[k.justifySelf||L[S%L.length]](this._rtl),q=wt[k.alignSelf||b[y%b.length]](),Z=k.colSpan||1,ct=e[S];if(Z>1&&S+Z<=this._nc)for(let W=1;W<Z;W++)ct+=e[S+W]+d[(S+W)%d.length];let E=ct*Y,H=i[y]*q,j=0,N=0,{width:tt,height:et}=k.world||k;if(k.anchor&&(j=k.anchor.x,N=k.anchor.y),Y==0)E=E+tt*j;else if(Y==.5){let W=j<.5?-1:j==.5?0:1;E=E+W*tt*Y}else E=E-tt*(1-j);if(q==0)H=H+et*N;else if(q==.5){let W=N<.5?-1:N==.5?0:1;H=H+W*et*q}else H=H-et*(1-N);k.x=U+E,k.y=w+H}U+=e[S]+d[S%d.length]}),w+=i[y]+l[y%l.length]})}}function v(){return new jt(...arguments)}function ot(s){let t=[];return s._dn?t.push(s._dn):s.children&&s.children.map(e=>{t=t.concat(ot(e))}),t}class Q{constructor({id:t,name:e=t,objects:i=[],context:h=C(),cullObjects:o=!0,cullFunction:r=Ct,sortFunction:u,...c}){this._o=[],Object.assign(this,{id:t,name:e,context:h,cullObjects:o,cullFunction:r,sortFunction:u,...c});let d=this._dn=document.createElement("section");d.tabIndex=-1,d.style=vt,d.id=t,d.setAttribute("aria-label",e);let l=this;class _ extends ${set x(w){l.sx=w-this.centerX,super.x=w}get x(){return super.x}set y(w){l.sy=w-this.centerY,super.y=w}get y(){return super.y}}this.camera=new _({context:h,anchor:{x:.5,y:.5},render:this._rf.bind(this)}),this.add(i),this._i=()=>{this.context??(this.context=C());let x=this.context.canvas,{width:w,height:m}=x,L=w/2,b=m/2;Object.assign(this.camera,{centerX:L,centerY:b,x:L,y:b,width:w,height:m}),this._dn.isConnected||ut(this._dn,x)},this.context&&this._i(),T("init",this._i)}set objects(t){this.remove(this._o),this.add(t)}get objects(){return this._o}add(...t){t.flat().map(e=>{this._o.push(e),e.parent=this,ot(e).map(i=>{this._dn.appendChild(i)})})}remove(...t){t.flat().map(e=>{mt(this._o,e),e.parent=null,ot(e).map(i=>{ut(i,this.context)})})}show(){this.hidden=this._dn.hidden=!1;let t=this._o.find(e=>e.focus);t?t.focus():this._dn.focus(),this.onShow()}hide(){this.hidden=this._dn.hidden=!0,this.onHide()}destroy(){Tt("init",this._i),this._dn.remove(),this._o.map(t=>t.destroy&&t.destroy())}lookAt(t){let{x:e,y:i}=t.world||t;this.camera.x=e,this.camera.y=i}update(t){this.hidden||this._o.map(e=>e.update&&e.update(t))}_rf(){let{_o:t,context:e,_sx:i,_sy:h,camera:o,sortFunction:r,cullObjects:u,cullFunction:c}=this;e.translate(i,h);let d=t;u&&(d=d.filter(l=>c(o,l))),r&&d.sort(r),d.map(l=>l.render&&l.render())}render(){if(!this.hidden){let{context:t,camera:e}=this,{x:i,y:h,centerX:o,centerY:r}=e;t.save(),this._sx=o-i,this._sy=r-h,t.translate(this._sx,this._sy),e.render(),t.restore()}}onShow(){}onHide(){}}class Nt{constructor(){n(this,"scenes");n(this,"currentScene");this.scenes=[]}init(t){this.scenes.push(...t),this.currentScene=this.scenes[0],this.currentScene.show()}start(t){this.currentScene.hide();for(let e of this.scenes)if(e.id==t){this.currentScene=e;break}this.currentScene.show()}}class zt extends Q{constructor(t){super({id:t})}onShow(){G.start("menu")}}let p=[];p.push({font:"72px Copperplate Gothic",color:"white",anchor:{x:.5,y:.5},textAlign:"center"});p.push({font:"48px Copperplate Gothic",color:"yellow",anchor:{x:.5,y:.5},textAlign:"center"});p.push({font:"24px Copperplate Gothic",color:"white",anchor:{x:0,y:0},textAlign:"left"});p.push({font:"80px Arial",color:"white",anchor:{x:.5,y:.5},textAlign:"center"});p.push({font:"180px Arial",color:"white",anchor:{x:.5,y:.5},textAlign:"center"});p.push({font:"20px Copperplate Gothic",color:"black",anchor:{x:0,y:0},textAlign:"left"});p.push({font:"48px Copperplate Gothic",color:"Black",anchor:{x:.5,y:0},textAlign:"center"});p.push({font:"32px Copperplate Gothic",color:"Black",anchor:{x:.5,y:0},textAlign:"center"});const a={yearLength:10,gameWidth:0,gameHeight:0,age:[10,40],wage:[10,30,5],ageBishop:[20,30],productionMatrix:[[0,0,0],[20,50,5],[-10,-5,3],[0,0,0],[-10,-5,3],[0,0,0],[-10,-5,3],[20,35,5],[-10,-5,3],[20,35,5],[0,0,0],[5,55,7]],reputationMatrix:[["",""],["",""],["Inefficient","Efficient"],["",""],["Inefficient","Efficient"],["",""],["Hungry","Small Appetite"],["Lazy","Hard working"],["Inefficient","Efficient"],["Lazy","Hard working"],["",""],["Lazy","Hard working"]],averageLifeExpectancy:35,curveWidthLifeExpectancy:5,workerLeaveChance:.25,newWorkerChance:.25};class It extends Q{constructor(t){super({id:t})}onShow(){let t=g({text:"Cathedral Master Builder",...p[0]}),e=g({text:"Start",...p[1],onDown:()=>{G.start("game")}}),i=g({text:"Credits",...p[1],onDown:()=>{console.log("Credits pressed")}});const h=a.gameHeight*.1;let o=v({x:a.gameWidth/2,y:h*2,anchor:{x:.5,y:0},rowGap:[h*1.5,h,h],justify:"center",children:[t,e,i]});P(e,i),this.add(o),G.start("game")}onHide(){}update(){super.update()}render(){super.render()}}const $t=["William","John","Richard","Robert","Thomas","Henry","Walter","Geoffrey","Peter","James","Simon","Roger","Stephen","Matthew","Nicholas","Gilbert","Alan","Philip","David","Hugh","Andrew","Martin","Adam","Bartholomew","Ralph","Lawrence","Reginald","Edmund","Gilbert","Jordan","Osbert","Godfrey","Eustace","Raymond","Roland","Cuthbert","Hubert","Abelard","Baldwin","Benedict","Conrad","Frederick","Godwin","Harold","Ingram","Lancelot","Maurice","Odo","Piers","Reynold"],Ut=["🧒","👦"],qt=["🧑","👱","👨","🧔","🧔‍♂️","👨‍🦰","👨‍🦲","🧑‍🦱","👱‍♂️"];class Jt{constructor(){}generateUniform(t){return Math.random()*(t[1]-t[0])+t[0]}}const ht=new Jt;class V{constructor(t){n(this,"name");n(this,"age");n(this,"wage");n(this,"emoji");n(this,"job");n(this,"jobEmoji");n(this,"production");n(this,"variation");n(this,"reputation");this.job=t,this.job=="empty"?this.name="Empty":this.name=this.getRandom($t),this.age=Math.round(ht.generateUniform(a.age)),this.setEmoji(),this.jobEmoji="🥖",this.production=[0,0,0,0,0,0],this.variation=[0,0,0,0,0,0],this.reputation=[],this.setValues()}getRandom(t){return t[Math.floor(Math.random()*t.length)]}setEmoji(){this.age<=18?this.emoji=this.getRandom(Ut):this.emoji=this.getRandom(qt)}birthday(){this.age=this.age+1,this.age==19&&this.setEmoji()}dies(){let t=1/(1+Math.exp((-this.age+a.averageLifeExpectancy)/a.curveWidthLifeExpectancy));return Math.random()<=t}setValues(){let t=[];this.job=="baker"?t=[0,-1,-1,1,-1,-1]:this.job=="smith"?(t=[0,0,-1,0,1,-1],this.jobEmoji="⚒️"):this.job=="mason"?(t=[0,-1,0,0,0,1],this.jobEmoji="🪨"):this.job=="bishop"?t=[1,-1,-1,-1,-1,-1]:this.job=="empty"&&(t=[-1,-1,-1,-1,-1,-1]);let e=0,i=0,h=[],o=[];for(let r=0;r<t.length;r++)t[r]>-1&&(i++,h=a.productionMatrix[r*2+t[r]],o=a.reputationMatrix[r*2+t[r]],this.production[r]=Math.round(ht.generateUniform(h)),this.variation[r]=h[2],this.production[r]>h[0]+.75*(h[1]-h[0])?(this.reputation.push(o[1]),e++):this.production[r]<h[0]+.25*(h[1]-h[0])&&(this.reputation.push(o[0]),e--));if(this.job!="empty"){let r=e/i;this.wage=Math.round((a.wage[0]+a.wage[1])/2+r*(a.wage[1]-a.wage[0])/2+ht.generateUniform([-a.wage[2],a.wage[2]])),this.job!="bishop"&&(this.production[0]=-this.wage)}}}class R{constructor(t,e,i,h,o,r,u){n(this,"name");n(this,"emoji");n(this,"description");n(this,"image");n(this,"compo");n(this,"fullYearbook");n(this,"placeType");n(this,"resources");n(this,"workers");this.fullYearbook=[],this.workers=[],this.name=i,this.placeType=r,this.resources=u,this.emoji=h,this.description=g({text:this.name,...p[2],onDown:()=>{this.click()}}),this.image=g({text:h,...p[o],onDown:()=>{this.click()}}),this.compo=v({x:a.gameWidth*t,y:a.gameHeight*e,anchor:{x:.5,y:.5},justify:"center",children:[this.image,this.description]}),P(this.description,this.image),this.writeYearbookEntry({year:1212,workerBalance:[{name:"-",balance:[0,0,0,0,0,0]},{name:"-",balance:[0,0,0,0,0,0]},{name:"-",balance:[0,0,0,0,0,0]},{name:"-",balance:[0,0,0,0,0,0]},{name:"-",balance:[0,0,0,0,0,0]}],overallBalance:[0,0,0,0,0,0],events:["No cathedral yet!"]});for(let c=0;c<5;c++)this.workers.push(new V("empty"))}click(){this.placeType!="Cathedral"&&M("clickPlace",this)}tick(){if(console.log("tick: "+this.name),this.placeType=="Town"){for(let t=0;t<this.workers.length;t++)if(this.workers[t].name!="Empty"&&Math.random()<=a.workerLeaveChance&&(this.workers[t]=new V("empty")),this.workers[t].name=="Empty")switch(t){case 0:this.workers[0]=new V("baker");break;case 1:this.workers[1]=new V("smith");break;case 2:this.workers[2]=new V("mason");break;default:if(Math.random()<=a.newWorkerChance){let e=Math.random(),i;e<.33?i="baker":e<.66?i="smith":i="mason",this.workers[t]=new V(i)}}}}writeYearbookEntry(t){this.fullYearbook.push(t)}readYearbookEntry(t){for(let e=0;e<this.fullYearbook.length;e++)if(this.fullYearbook[e].year==t)return this.fullYearbook[e];return this.fullYearbook[this.fullYearbook.length-1]}yearExist(t){for(let e=0;e<this.fullYearbook.length;e++)if(t==this.fullYearbook[e].year)return!0;return!1}numberOfWorkers(){let t=0;for(let e=0;e<this.workers.length;e++)this.workers[e].name!="empty"&&t++;return t}nextEmptyWorkerSpot(){for(let t=0;t<this.workers.length;t++)if(this.workers[t].name=="Empty")return t;return-1}}class rt extends ${constructor(e){super({x:e.x,y:e.y});n(this,"properties");n(this,"length");this.properties=e,this.length=this.properties.length}draw(){this.context.strokeStyle=this.properties.color,this.context.beginPath(),this.context.moveTo(0,0),this.properties.horizontal?this.context.lineTo(this.properties.length,0):this.context.lineTo(0,this.properties.length),this.context.lineWidth=this.properties.width,this.context.stroke()}}class Kt extends X{constructor(){super({x:0,y:0,width:0,height:0});n(this,"shadow");n(this,"cover");n(this,"page");n(this,"lineSeparator");n(this,"year");n(this,"showLinesLeft");n(this,"showLinesRight");n(this,"linesLeft");n(this,"linesRight");n(this,"showTextLeft");n(this,"showTextLeftMulticol");n(this,"showTextRight");n(this,"textLeft");n(this,"textRight");n(this,"textLeftMulticol");n(this,"textLeftGrid");n(this,"textRightGrid");n(this,"textLeftMulticolGrid");n(this,"showNextButton");n(this,"showPreviousButton");n(this,"nextButton");n(this,"previousButton");this.year=[],this.showLinesLeft=!0,this.showLinesRight=!0,this.showTextLeft=!1,this.showTextRight=!0,this.showTextLeftMulticol=!0,this.showNextButton=!0,this.showPreviousButton=!0;let e=a.gameWidth*.01,i=a.gameWidth*.01,h=9,o=[a.gameHeight*.02,a.gameHeight*.02,a.gameHeight*.12,a.gameHeight*.07];this.cover=z({x:a.gameWidth*.01,y:a.gameHeight*.12,width:a.gameWidth*.9,height:a.gameHeight*.85,color:"#4A0404"}),this.shadow=z({x:this.cover.x+e,y:this.cover.y+e,width:this.cover.width,height:this.cover.height,color:"black",opacity:.3}),this.page=z({x:this.cover.x+i,y:this.cover.y+i/2,width:this.cover.width-2*i,height:this.cover.height-i,color:"#E1C16E"}),this.lineSeparator=new rt({x:this.cover.x+this.cover.width/2,y:this.page.y,length:this.page.height,horizontal:!1,width:1,color:"black"});for(let f=0;f<2;f++)this.year.push(g({x:this.page.x+this.page.width*(.25+.5*f),y:this.page.y+o[0],text:"1213",...p[7]}));this.addChild([this.shadow,this.cover,this.page,this.lineSeparator,...this.year]);let r=[],u=[],c=this.page.x+2*i,d=this.page.width/2-4*i,l={x:0,y:0,horizontal:!0,width:1,color:"black"};for(let f=0;f<h;f++)r.push(new rt({...l,length:d})),u.push(new rt({...l,length:d}));this.linesLeft=v({x:c,y:this.year[0].y+this.year[0].height+o[2],rowGap:o[3],children:r}),this.linesRight=v({x:c+d+4*i,y:this.year[0].y+this.year[0].height+o[2],rowGap:o[3],children:u}),this.textLeft=[],this.textRight=[],this.textLeftMulticol=[];let _=7,x={x:0,y:0,text:"t",...p[5]};for(let f=0;f<h;f++){this.textLeft.push(g(x)),this.textRight.push(g(x));for(let y=0;y<_;y++)this.textLeftMulticol.push(g(x))}let w=this.linesLeft.y-Number(this.linesLeft.rowGap)*.75,m=Number(this.linesLeft.rowGap)-this.textLeft[0].height,L=a.gameWidth*.01;this.textLeftGrid=v({x:this.linesLeft.x,y:w,rowGap:m,children:this.textLeft}),this.textRightGrid=v({x:this.linesRight.x,y:w,rowGap:m,children:this.textRight}),this.textLeftMulticolGrid=v({x:this.linesLeft.x,y:w,rowGap:m,colGap:L,numCols:_,flow:"grid",justify:["start","end","end","end","end","end","end"],children:this.textLeftMulticol});let b=.01*a.gameWidth;this.previousButton=g({x:this.page.x+b,y:this.page.y+b,text:"⬅️",...p[6],anchor:{x:0,y:0},onDown:()=>{M("previousButton")}}),this.nextButton=g({x:this.page.x+this.page.width-b,y:this.page.y+b,text:"➡️",...p[6],anchor:{x:1,y:0},onDown:()=>{M("nextButton")}}),P(this.previousButton,this.nextButton)}update(){super.update(),this.textLeftMulticolGrid.update()}render(){super.render(),this.showLinesLeft&&this.linesLeft.render(),this.showLinesRight&&this.linesRight.render(),this.showTextLeft&&this.textLeftGrid.render(),this.showTextRight&&this.textRightGrid.render(),this.showTextLeftMulticol&&this.textLeftMulticolGrid.render(),this.showPreviousButton&&this.previousButton.render(),this.showNextButton&&this.nextButton.render()}setupPages(e,i,h,o,r,u,c,d){for(let l=0;l<this.year.length;l++)this.year[l].text=String(e);if(this.showLinesLeft=i,this.showLinesRight=h,this.showTextLeft=o,this.showTextRight=r,this.showTextLeftMulticol=u,this.showTextLeft)for(let l=0;l<this.textLeft.length;l++)l<c.length?this.textLeft[l].text=c[l]:this.textLeft[l].text="";if(this.showTextRight)for(let l=0;l<this.textRight.length;l++)l<d.length?this.textRight[l].text=d[l]:this.textRight[l].text="";if(this.showTextLeftMulticol)for(let l=0;l<this.textLeftMulticol.length;l++)l<c.length?this.textLeftMulticol[l].text=c[l]:this.textLeftMulticol[l].text=""}}class Qt extends X{constructor(e,i,h,o){super({x:e,y:i,color:"blue",onDown:o});n(this,"text");this.text=g({text:h,...p[2],anchor:{x:.5,y:.5}}),this.width=this.text.width+2*a.gameWidth*.01,this.height=this.text.height+2*a.gameWidth*.005,this.text.x=this.width/2,this.text.y=this.height/2,this.addChild(this.text),P(this)}setText(e){this.text.text=e}onDown(){}}class yt extends X{constructor(e,i){super({x:e,y:a.gameHeight*.12,width:a.gameWidth*.17,height:a.gameHeight*.85,color:"#E1C16E"});n(this,"shadow");n(this,"background");n(this,"name");n(this,"picture");n(this,"job");n(this,"age");n(this,"wage");n(this,"characteristics");n(this,"reputation");n(this,"hireFireButton");n(this,"hireFireButtonVisible");n(this,"tilePosition");this.hireFireButtonVisible=!1,this.tilePosition=i;let h=a.gameWidth*.008,o=[0,a.gameHeight*.05,a.gameHeight*.02],r=[a.gameWidth*.01];this.name=g({x:this.width/2,y:o[0],text:"",...p[7]}),this.shadow=z({x:h,y:h,width:this.width,height:this.height,color:"black",opacity:.3}),this.background=z({x:0,y:0,width:this.width,height:this.height,color:this.color}),this.picture=g({x:this.width/2,y:this.name.y+this.name.height+o[1],text:"",...p[3],anchor:{x:.5,y:0}}),this.job=g({text:"",...p[5]}),this.age=g({text:"",...p[5]}),this.wage=g({text:"",...p[5]});let u=v({x:r[0],y:this.picture.y+this.picture.height+o[1]/2,justify:"start",children:[g({text:"Job:",...p[5]}),g({text:"Age:",...p[5]}),g({text:"Wage:",...p[5]})]});this.characteristics=v({x:this.width-r[0],y:u.y,justify:"end",anchor:{x:1,y:0},children:[this.job,this.age,this.wage]});let c=g({x:u.x,y:u.y+u.height+o[1]/2,text:"Reputation:",...p[5],width:this.width-2*r[0]});this.reputation=g({x:c.x,y:c.y+c.height,text:"",...p[5],width:this.width-2*r[0]}),this.hireFireButton=new Qt(0,0,"Hire",()=>{this.clickButton()}),this.hireFireButton.x=this.x+this.width/2-this.hireFireButton.width/2,this.hireFireButton.y=this.y+this.height-o[2]-this.hireFireButton.height,this.addChild([this.shadow,this.background,this.name,this.picture,u,this.characteristics,c,this.reputation])}render(){super.render(),this.hireFireButtonVisible&&this.hireFireButton.render()}hideButton(){this.hireFireButtonVisible=!1}showButton(e){this.hireFireButtonVisible=!0,this.hireFireButton.setText(e)}clickButton(){M("hireFire",this.tilePosition)}}class Zt extends X{constructor(){super({x:0,y:0,width:0,height:0});n(this,"tiles");let e=a.gameWidth*.01;this.tiles=[],this.tiles.push(new yt(e,0));let i=this.tiles[0].width+a.gameWidth*.01;for(let h=1;h<5;h++)this.tiles.push(new yt(this.tiles[h-1].x+i,h));this.addChild(this.tiles)}setWorkerTiles(e,i){for(let h=0;h<e.length;h++)if(this.tiles[h].name.text=e[h].name,e[h].name!="Empty"){if(this.tiles[h].picture.text=e[h].emoji,this.tiles[h].job.text=e[h].jobEmoji,this.tiles[h].age.text=String(e[h].age),this.tiles[h].wage.text=String(e[h].wage),e[h].reputation.length<=0)this.tiles[h].reputation.text="-";else{let o=e[h].reputation[0];for(let r=1;r<e[h].reputation.length;r++)o=o+", "+e[h].reputation[r];this.tiles[h].reputation.text=o}i=="Town"?this.tiles[h].showButton("Hire"):this.tiles[h].showButton("Fire")}else this.tiles[h].picture.text="⬜",this.tiles[h].job.text="-",this.tiles[h].age.text="-",this.tiles[h].wage.text="-",this.tiles[h].reputation.text="-",this.tiles[h].hideButton()}}class te extends X{constructor(e){super({x:0,y:0,width:a.gameWidth,height:a.gameHeight,color:"#EADDCA"});n(this,"visible");n(this,"bookVisible");n(this,"workersVisible");n(this,"workerButtonVisible");n(this,"bookButtonVisible");n(this,"title");n(this,"cancelButton");n(this,"book");n(this,"workers");n(this,"workerButton");n(this,"bookButton");n(this,"place");this.place=e,this.visible=!1,this.bookVisible=!0,this.workersVisible=!1,this.bookButtonVisible=!1,this.workerButtonVisible=!0,this.book=new Kt,this.workers=new Zt,this.title=g({x:this.width/2,y:a.gameHeight*5e-4,text:"Title",...p[6]}),this.cancelButton=g({x:a.gameWidth*.96,y:a.gameWidth*.02,text:"✖️",...p[6],anchor:{x:.5,y:.5},onDown:()=>{this.hide()}}),P(this.cancelButton),this.addChild([this.title,this.cancelButton]),this.workerButton=g({x:this.cancelButton.x,y:this.book.page.y+this.book.page.height/2,text:"🧔‍♂️",...p[6],anchor:{x:.5,y:.5},onDown:()=>{this.bookVisible=!1,this.workersVisible=!0,this.workerButtonVisible=!1,this.bookButtonVisible=!0}}),this.bookButton=g({x:this.workerButton.x,y:this.workerButton.y,text:"📙",...p[6],anchor:{x:.5,y:.5},onDown:()=>{this.bookVisible=!0,this.workersVisible=!1,this.workerButtonVisible=!0,this.bookButtonVisible=!1}}),P(this.workerButton,this.bookButton),T("previousButton",()=>{this.fillPageWorkshop(Number(this.book.year[0].text)-1)}),T("nextButton",()=>{this.fillPageWorkshop(Number(this.book.year[0].text)+1)})}update(){super.update(),this.book.update(),this.workers.setWorkerTiles(this.place.workers,this.place.placeType),this.workers.update(),this.book.showPreviousButton=this.place.yearExist(Number(this.book.year[0].text)-1),this.book.showNextButton=this.place.yearExist(Number(this.book.year[0].text)+1)}render(){this.visible&&(super.render(),this.bookVisible&&this.book.render(),this.workersVisible&&this.workers.render(),this.bookButtonVisible&&this.bookButton.render(),this.workerButtonVisible&&this.workerButton.render())}show(e,i){this.visible=!0,this.place=e,this.title.text=this.place.name+" "+this.place.emoji,this.place.placeType=="Workshop"?(this.bookVisible=!0,this.workersVisible=!1,this.workerButtonVisible=!0,this.bookButtonVisible=!1,this.fillPageWorkshop(i)):this.place.placeType=="Bishop"?(this.bookVisible=!0,this.workersVisible=!1,this.workerButtonVisible=!1,this.bookButtonVisible=!1,this.fillPageWorkshop(i)):this.place.placeType=="Market"?(this.bookVisible=!0,this.workersVisible=!1,this.workerButtonVisible=!1,this.bookButtonVisible=!1):this.place.placeType=="Town"&&(this.bookVisible=!1,this.workersVisible=!0,this.workerButtonVisible=!1,this.bookButtonVisible=!1),this.workers.setWorkerTiles(this.place.workers,this.place.placeType)}hide(){this.visible=!1}fillPageWorkshop(e){let i=this.place.readYearbookEntry(e),h=this.place.resources,o=["🪙","🧲","🪨","🥖","⚒️","⛪"],r=[];r.push("Balance:","","","","","","","");for(let c=0;c<h.length;c++)h[c]?r.push(o[c]):r.push(" ");for(let c=0;c<i.workerBalance.length;c++){r.push(i.workerBalance[c].name);for(let d=0;d<i.workerBalance[c].balance.length;d++)h[d]?r.push(String(i.workerBalance[c].balance[d])):r.push(" ")}r.push("","","","","","",""),r.push("Overall:");for(let c=0;c<i.overallBalance.length;c++)h[c]?r.push(String(i.overallBalance[c])):r.push("");let u=[];u.push("Events:");for(let c=0;c<i.events.length;c++)u.push(i.events[c]);this.book.setupPages(i.year,!0,!0,!1,!0,!0,r,u)}}class ee extends Q{constructor(e){super({id:e});n(this,"money");n(this,"stone");n(this,"iron");n(this,"bread");n(this,"tools");n(this,"places");n(this,"cathedral");n(this,"year");n(this,"progress");n(this,"tickLength");n(this,"lastTickTime");n(this,"nextTick");n(this,"insidePlace");this.places=[]}onShow(){this.year=g({text:"1213",...p[0],x:a.gameWidth*.55,y:a.gameHeight*.1}),this.money=g({text:"🪙: 0 FRT",...p[2]}),this.stone=g({text:"🪨: 0 kg",...p[2]}),this.iron=g({text:"🧲: 0 kg",...p[2]}),this.bread=g({text:"🥖: 0 pcs",...p[2]}),this.tools=g({text:"⚒️: 0 pcs",...p[2]});let e=v({x:a.gameWidth*.01,y:a.gameWidth*.01,anchor:{x:0,y:0},rowGap:a.gameHeight*.02,children:[this.money,this.stone,this.iron,this.bread,this.tools]});this.places.push(new R(.05,.55,"Market","🧺",3,"Market",[!1,!1,!1,!1,!1,!1])),this.places.push(new R(.05,.85,"Town","🏘️",3,"Town",[!1,!1,!1,!1,!1,!1])),this.places.push(new R(.25,.75,"Bishop","✝️",3,"Bishop",[!0,!1,!1,!1,!1,!1])),this.places.push(new R(.37,.35,"Bakery","🥖",3,"Workshop",[!0,!1,!1,!0,!1,!1])),this.places.push(new R(.73,.35,"Blacksmith","⚒️",3,"Workshop",[!0,!0,!1,!0,!0,!1])),this.places.push(new R(.85,.75,"Masonry","🪨",3,"Workshop",[!0,!1,!0,!0,!0,!0])),this.cathedral=new R(.55,.63,"Cathedral","⛪",4,"Cathedral",[!1,!1,!1,!1,!1,!1]),this.progress=g({text:"100 %",...p[1],x:a.gameWidth*.55,y:a.gameHeight*.9}),this.progress.color="white",this.insidePlace=new te(this.places[1]),this.add([this.year,e,this.cathedral.compo,this.progress]);for(let i of this.places)this.add(i.compo);this.add([this.insidePlace]),T("clickPlace",i=>{this.insidePlace.visible||this.insidePlace.show(i,Number(this.year.text))}),T("hireFire",i=>{this.hireFire(i)}),this.tickLength=Math.round(a.yearLength*1e3/this.places.length),this.lastTickTime=Date.now()-this.tickLength,this.nextTick=0}onHide(){}update(){super.update(),Date.now()-this.lastTickTime>this.tickLength&&(this.lastTickTime=Date.now(),this.places[this.nextTick].tick(),this.nextTick++,this.nextTick>=this.places.length&&(this.nextTick=0,this.year.text=String(Number(this.year.text)+1)))}render(){super.render()}hireFire(e){let i=this.insidePlace.place;if(i.name=="Town"){let h;switch(this.places[1].workers[e].job){case"baker":h=this.places[3];break;case"smith":h=this.places[4];break;default:h=this.places[5]}h.workers[h.nextEmptyWorkerSpot()]=i.workers[e]}i.workers[e]=new V("empty")}}class ie extends Q{constructor(t){super({id:t})}onShow(){let t=g({text:"You WON!",...p[1],x:a.gameWidth/2,y:a.gameHeight/2,onDown:()=>{G.start("menu")}});P(t),this.add(t)}onHide(){}update(){super.update()}render(){super.render()}}let{canvas:O,context:le}=Wt();Ft();a.gameWidth=O.width;a.gameHeight=O.height;addEventListener("resize",Bt);Bt();const se=new zt("loading"),he=new It("menu"),re=new ee("game"),ne=new ie("win");let G=new Nt;G.init([se,he,re,ne]);let oe=Dt({update:function(){G.currentScene.update()},render:function(){G.currentScene.render()}});oe.start();function Bt(){let s=a.gameWidth/a.gameHeight;window.innerWidth/s>window.innerHeight?(O.style.height=String(window.innerHeight)+"px",O.style.width=String(window.innerHeight*s)+"px"):(O.style.width=String(window.innerWidth)+"px",O.style.height=String(window.innerWidth/s)+"px")}

	</script>
  </head>
  <style>
    canvas {
      background-color: green;
      padding: 0;
      margin: auto;
      display: block;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    body {
      margin: 0;
      background-color: grey;
    }
  </style>
  <body>
  <canvas id="gameCanvas" width="1140" height="540"></canvas>
  
  </body>
</html>
